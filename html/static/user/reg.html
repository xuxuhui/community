<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>注册</title>
    <link rel="stylesheet" href="/static/layui/font/font_24081_1u8t0gopzoxbt9.css" />
    <link rel="stylesheet" href="/static/layui/css/layui.css?t=1506053054561" />
    <link rel="stylesheet" href="/static/layui/css/global.css" charset="utf-8" />
    <script src="/static/node_modules/avalon2/dist/avalon.js"></script>
</head>

<body>
    <div class="header">
        <div class="main">
            <div style="margin-top:18px; position: absolute;">
                <a class="" style="color: #F0F0F0;" href="/">享你所想</a>
            </div>
            <div class="nav-user">
                <a class="unlogin" href="/static/user/login.html"><i class="iconfont icon-touxiang"></i></a>
                <span><a href="/static/user/login.html">登入</a><a href="/static/user/reg.html">注册</a></span>
            </div>
        </div>
    </div>
    <div class="main layui-clear" ms-controller="reg">
        <div class="fly-panel fly-panel-user" pad20="">
            <div class="layui-tab layui-tab-brief" lay-filter="user">
                <ul class="layui-tab-title">
                    <li class="layui-this">注册</li>
                    <li class="">邮箱注册</li>
                </ul>
                <div class="layui-form layui-tab-content" id="LAY_ucm" style="padding: 20px 0;">
                    <div class="layui-tab-item layui-show">
                        <div class="layui-form layui-form-pane">
                            <form method="post">
                                <div class="layui-form-item">
                                    <label for="mobile" class="layui-form-label">手机号</label>
                                    <div class="layui-input-inline">
                                        <input id="mobile" name="email" required="" lay-verify="phone" autocomplete="off" class="layui-input" ms-duplex="@mobile" />
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">
                                        将会成为您唯一的登入名
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label for="img_code" class="layui-form-label">图片验证码</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="img_code" name="img_code" required="" lay-verify="required" autocomplete="off" class="layui-input" ms-duplex="@img_code" />
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">
                                        <img ms-attr="{src: @img}" onclick="changeImg()" />
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label for="mobile_code" class="layui-form-label">手机验证码</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="mobile_code" name="email" required="" autocomplete="off" class="layui-input" ms-duplex="@mobile_code" />
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">
                                        <a type="button" class="layui-btn" id="send_mobile" style="width:100px">
              <span id="send_str" onclick="getMobileCode(this, 60)">获取验证码</span>
            </a>
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label for="username" class="layui-form-label">昵称</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="username" name="username" required="" lay-verify="required" autocomplete="off" class="layui-input" ms-duplex="@name" onblur="verifyName()" />
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label for="L_pass" class="layui-form-label">密码</label>
                                    <div class="layui-input-inline">
                                        <input type="password" id="L_pass" name="pass" required="" autocomplete="off" class="layui-input" ms-duplex="@password" />
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">
                                        6位以上含大小写
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label for="L_repass" class="layui-form-label">确认密码</label>
                                    <div class="layui-input-inline">
                                        <input type="password" id="L_repass" name="repass" required="" autocomplete="off" class="layui-input" ms-duplex="@confirm_password" />
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <a href="javascript:;" class="layui-btn" lay-filter="*" onclick="register()">立即注册</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="layui-tab-item">
                        <div class="layui-form layui-form-pane">
                            <form method="post">
                                <div class="layui-form-item">
                                    <label for="L_email" class="layui-form-label">邮箱</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="email" name="email" required="" autocomplete="off" class="layui-input" ms-duplex="@email" />
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">
                                        将会成为您唯一的登入名
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label for="mail_code" class="layui-form-label">验证码</label>
                                    <div class="layui-input-inline">
                                        <input type="text" id="mail_code" name="" required="" lay-verify="required" autocomplete="off" class="layui-input" ms-duplex="@email_code" />
                                    </div>
                                    <div class="layui-form-mid layui-word-aux">
                                        <a type="button" class="layui-btn" id="send_mobile" style="width:100px">
                                          <span id="send_str" onclick="getMailCode(this)">获取验证码</span>
                                        </a>
                                    </div>
                                    <div class="layui-form-item">
                                        <label for="username" class="layui-form-label">昵称</label>
                                        <div class="layui-input-inline">
                                            <input type="text" id="username" name="username" required="" lay-verify="required" autocomplete="off" class="layui-input" ms-duplex="@mail_name" onblur="verifyName()" />
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label for="L_pass" class="layui-form-label">密码</label>
                                        <div class="layui-input-inline">
                                            <input type="password" id="L_pass" name="pass" required="" autocomplete="off" class="layui-input" ms-duplex="@mail_password" />
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">
                                            6位以上含大小写
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label for="L_repass" class="layui-form-label">确认密码</label>
                                        <div class="layui-input-inline">
                                            <input type="password" id="L_repass" name="repass" required="" autocomplete="off" class="layui-input" ms-duplex="@mail_confirm_password" />
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <a class="layui-btn" lay-filter="*" lay-submit="" onclick="mailRegister()">立即注册</a>
                                    </div>
                            </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="/static/layui/layui.js"></script>
        <script src="/static/app/alloy.js"></script>
        <script src="/static/jquery/jquery-3.2.1.min.js"></script>
        <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script> -->
        <script>
        var host = alloy_setting.request_url;
        var time = 0;
        var mobile_time = 0;

        layui.use('element', function() {
            var $ = layui.jquery,
                element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
        });

        layui.use('layer', function() {
            var layer = layui.layer;
        });

        var vm = avalon.define({
            $id: "reg",
            img_code: "", // 用户输入的图片验证码
            mobile: "",
            mobile_code: "",
            name: "",
            password: "",
            confirm_password: "",
            img: "",
            uid: "",
            error: {
                mobile: "",
                name: "",
                img_code: ""
            },
            email: "",
            email_code: "",
            mail_name: "",
            mail_password: "",
            mail_confirm_password: ""
        })

        $(document).ready(function() {

            // 页面加载后获取图片验证码
            var request_url = host + "/api/user/getImageCode";
            $.ajax({
                type: "GET",
                url: request_url,
                success: function(data) {
                    if (data.status == 200) {
                        var return_data = data.data;
                        var uid = return_data.key;
                        var value = return_data.value;
                        vm.uid = uid
                        vm.img = "data:image/png;base64," + value
                    } else {
                        layer.msg(data.msg, { icon: 5 });
                    }
                }
            });
        });

        function changeImg() {

            var request_url = host + "/api/user/getImageCode";
            $.ajax({
                type: "GET",
                url: request_url,
                success: function(data) {
                    if (data.status == 200) {
                        var return_data = data.data;
                        var uid = return_data.key;
                        var value = return_data.value;
                        vm.uid = uid
                        vm.img = "data:image/png;base64," + value
                    } else {
                        layer.msg(data.msg, { icon: 5 });
                    }
                }
            });
        }

        function getMobileCode(obj) {

            if (!SimpoValidate.mobile(vm.mobile)) {
                layer.msg('请输入正确的手机号', { icon: 5 });
                return;
            }

            if (mobile_time != 0) {
                return;
            }

            // 先判断注册？
            request_url = host + "/api/user/isExist";
            var data = { "mobile": vm.mobile };
            var is_register = false;
            $.ajax({
                type: "POST",
                url: request_url,
                contentType: "application/json",
                dataType: "json",
                async: false,
                data: JSON.stringify(data),
                success: function(data) {
                    // console.log(data);
                    if (data.status == 200) {
                        if (data.data) {
                            is_register = true;
                        }
                    } else {
                        layer.msg(data.msg, { icon: 5 });
                    }
                }
            });

            if (is_register) {
                layer.msg("用户已注册", { icon: 5 });
                return;
            }

            var request_url = host + "/api/user/sendMobile"
            var img_code = vm.img_code.toLowerCase();
            var data = { "mobile": vm.mobile, "uid": vm.uid, "code": img_code };
            console.log(data);
            $.ajax({
                type: "POST",
                url: request_url,
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify(data),
                success: function(data) {
                    // console.log(data);
                    if (data.status == 200) {
                        settimeMobile(obj, 60);
                        layer.msg("验证码发送成功", { icon: 6 });
                    } else {
                        layer.msg(data.msg, { icon: 5 });
                    }
                }
            });

        }

        function verifyName() {
            if (vm.name != "") {
                var request_url = host + "/api/user/verifyName"
                var data = { "name": vm.name };
                console.log(data);
                $.ajax({
                    type: "POST",
                    url: request_url,
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify(data),
                    success: function(data) {
                        if (data.status == 200) {} else {
                            alert(data.msg);
                        }
                    }
                });
            }
        }

        function register() {

            if (!SimpoValidate.mobile(vm.mobile)) {
                layer.msg('请输入正确的手机号', { icon: 5 });
                return;
            }
            if (vm.mobile_code == "") {
                layer.msg('请输入手机验证码', { icon: 5 });
                return;
            }
            if (vm.name == "") {
                layer.msg('请输入用户名', { icon: 5 });
                return;
            }
            if (!SimpoValidate.password(vm.password)) {
                layer.msg('请输入正确密码格式', { icon: 5 });
                return;
            }
            if (vm.password != vm.confirm_password) {
                layer.msg('两次密码不一致', { icon: 5 });
                return;
            }
            var data = {};
            data["mobile"] = vm.mobile;
            data["name"] = vm.name;
            data["password"] = vm.password;
            data["code"] = vm.mobile_code;
            var request_url = host + "/api/user/register"
            $.ajax({
                type: "POST",
                url: request_url,
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify(data),
                success: function(data) {
                    console.log(data);
                    if (data.status == 200) {
                        layer.msg("注册成功, 5秒后跳转到登录页", { icon: 6 });
                        setTimeout(function() {
                            window.location.href = host + "/static/user/login.html"
                        }, 5000);
                    } else {
                        layer.msg(data.msg);
                    }
                }
            });
        }

        function getMailCode(obj) {

            if (time != 0) {
                return;
            }

            if (!SimpoValidate.email(vm.email)) {
                layer.msg('请输入正确的邮箱', { icon: 5 });
                return;
            }

            request_url = host + "/api/user/isExist";
            var data = { "email": vm.email };
            var is_register = false;
            $.ajax({
                type: "POST",
                url: request_url,
                contentType: "application/json",
                dataType: "json",
                async: false,
                data: JSON.stringify(data),
                success: function(data) {
                    console.log(data);
                    if (data.status == 200) {
                        if (data.data) {
                            is_register = true;
                        }
                    } else {
                        layer.msg(data.msg, { icon: 5 });
                    }
                }
            });

            if (is_register) {
                layer.msg("用户已注册", { icon: 5 });
                return;
            }

            settime(obj, 60);
            var request_url = host + "/api/user/sendEmail";
            var data = { "email": vm.email };
            $.ajax({
                type: "POST",
                url: request_url,
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify(data),
                success: function(data) {
                    if (data.status == 200) {
                        layer.msg("验证码发送成功", { icon: 6 });
                    } else {
                        layer.msg(data.msg, { icon: 5 });
                    }
                }
            });
        }

        function mailRegister() {

            if (!SimpoValidate.email(vm.email)) {
                layer.msg('请输入正确的邮箱', { icon: 5 });
                return;
            }

            if (vm.mail_code == "") {
                layer.msg('验证码错误', { icon: 5 });
                return;
            }

            if (vm.mail_name == "") {
                layer.msg('请输入用户名', { icon: 5 });
                return;
            }

            if (!SimpoValidate.password(vm.mail_password)) {
                layer.msg('请输入正确密码格式', { icon: 5 });
                return;
            }

            if (vm.mail_confirm_password != vm.mail_password) {
                layer.msg('两次密码不一致', { icon: 5 });
                return;
            }

            var data = {};
            data["email"] = vm.email;
            data["name"] = vm.mail_name;
            data["password"] = vm.mail_password;
            data["code"] = vm.email_code;
            var request_url = host + "/api/user/register"
            console.log(data);
            $.ajax({
                type: "POST",
                url: request_url,
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify(data),
                success: function(data) {
                    console.log(data);
                    if (data.status == 200) {
                        layer.msg("注册成功, 5秒后跳转到登录页", { icon: 6 });
                        setTimeout(function() {
                            window.location.href = host + "/static/user/login.html"
                        }, 5000);
                    } else {
                        layer.msg(data.msg);
                    }
                }
            });

        }

        function settime(obj, time) {
            if (time == 0) {
                $(obj).parent().attr("disabled", false);
                $(obj).parent().css("background", "#009688").css("cursor", "pointer");
                $(obj).text("获取验证码");
                return;
            } else {
                $(obj).parent().attr("disabled", true);
                $(obj).parent().css("background", "#ccc").css("cursor", "not-allowed");
                $(obj).text("重新发送(" + time + ")");
                time--;
                console.log(time);
            }
            setTimeout(function() { settime(obj, time) }, 1000)
        }

        function settimeMobile(obj, mobile_time) {
            if (mobile_time == 0) {
                $(obj).parent().attr("disabled", false);
                $(obj).parent().css("background", "#009688").css("cursor", "pointer");
                $(obj).text("获取验证码");
                return;
            } else {
                $(obj).parent().attr("disabled", true);
                $(obj).parent().css("background", "#ccc").css("cursor", "not-allowed");
                $(obj).text("重新发送(" + mobile_time + ")");
                mobile_time--;
                console.log(mobile_time);
            }
            setTimeout(function() { settime(obj, mobile_time) }, 1000)
        }
        </script>
</body>

</html>